<!--
SPDX-FileCopyrightText: 2025 Leon Pohl <leon.pohl@unibw.de>

SPDX-License-Identifier: Apache-2.0
-->

# Generated build targets (graph_macro)

This document describes the Bazel targets generated by the `graph_macro` shown below, which builds a processing graph for a list of ROS bag files.

The macro combines:

- **NuScenes export** for **ROS1 and ROS2** bags via `single_rosbag_to_nuscenes`
- **Visual/ROS1 pipeline** (images, transforms, trajectories, sequences, metadata, etc.) via `declare_rosbag_per_target` (ROS1 only)
- **Cross-bag aggregation**: maps from OXTS and merged world-model annotations
- **Convenience filegroups**: “everything”, “visual”, “nuscenes”
- *(Optional)* a per-bag “print all files created” helper via `print_nuscenes` (currently commented out in the code)

---

## Macro inputs

```python
def graph_macro(name, input_bag_files, output_dir = "output"):
    ...
```

- `name`: base name used for *global* aggregate targets (e.g. `data_pipeline_processed`)
- `input_bag_files`: list of bag file paths (strings)
- `output_dir`: output folder argument passed to the NuScenes exporter (default: `"output"`)

---

## Filtering and validation

### 1) Path filtering (always on)

Before any targets are created, bags are filtered by `isPathValid()`:

- Excludes file paths containing `"copy"` (case-insensitive)
- Excludes file paths containing `"filtered"` (case-insensitive)

So those bags are skipped entirely.

### 2) ROS1 vs ROS2 behavior

- **ROS1 bags** (`*.bag`) run the full visual pipeline via `declare_rosbag_per_target(...)` *and* the NuScenes export.
- **ROS2 bags** (anything **not** ending in `.bag`) run **only** the NuScenes export.

### 3) “Validate” behavior inside the ROS1 pipeline

Inside `graph_macro`, a local variable is set:

```python
validate = True
```

and then passed into:

```python
declare_rosbag_per_target(..., validate = validate)
```

What “valid” means depends on the implementation of `declare_rosbag_per_target` (typically a whitelist/prefilter or topic checks).

- If `r["valid"]` is `True`, the bag contributes to:
  - `all_oxts` (maps)
  - `all_sequences` + `all_metadata` (merged annotations)
- If `r["valid"]` is `False`, the bag still contributes to `r["processed"]` / per-bag targets, but it **does not** feed the map and annotation aggregation steps.

---

## Naming scheme

For each `bag_file`, a `stem` is computed from the file name (sanitized) plus a hash suffix:

```python
stem = "<filename_without_ext>_<hash>"
```

Per-bag targets are named using that `stem`. Global aggregates are named using `name`.

---

## Per-bag targets

For each bag you will usually see targets like:

### NuScenes export (ROS1 + ROS2)

- `:<stem>_rosbag_to_nuscenes`  
  Produced by `single_rosbag_to_nuscenes(...)`.

### Visual/ROS1 pipeline targets (ROS1 only)

Produced by `declare_rosbag_per_target(...)`. The exact set can vary by implementation, but based on your `bazel query` output you get:

- `:<stem>__processed` — pipeline “processed” root output (used in aggregates)
- `:<stem>__metadata` — metadata extracted from the bag
- `:<stem>__oxts` — OXTS/GPS CSV outputs
- `:<stem>__images` — extracted images / frames
- `:<stem>__sequences` — image sequences (folder structure)
- `:<stem>__transforms` — extracted transforms
- `:<stem>__trajectory` — trajectory output (general)
- `:<stem>__trajectory_camera` — camera trajectory output
- `:<stem>__trajectory_rear_axis` — rear-axis trajectory output
- `:<stem>__sequence_traj_preview` — trajectory previews on sequences
- `:<stem>__camera_info` — camera info output (if present)

### Per-bag convenience aggregation

For ROS1 bags, `graph_macro` also creates:

- `:<stem>__everything` (filegroup)  
  Contains:
  - `:<stem>_rosbag_to_nuscenes`
  - `:<stem>__processed`

---

## Global aggregate targets

All global targets are created once per `graph_macro(name=...)`.

### `:<name>__oxts_all` (filegroup)

Collects OXTS outputs from **valid ROS1 bags only** (`r["valid"] == True`).

### `:<name>__maps`

Created by `oxts_to_maps(...)` from `:<name>__oxts_all`.  
Also appended into `:<name>__everything`.

### `:<name>__wm_annos`

Created by `merge_worldmodel_annotations(...)` using:

- `inputs = all_sequences` (valid-only)
- `metadata = all_metadata` (valid-only)

Also appended into `:<name>__everything`.

### `:<name>__wm_annos_single_file`

Same as `__wm_annos`, but with `single = True`.  
Also appended into `:<name>__everything`.

### `:<name>__visual_data` (filegroup)

A convenience filegroup containing `r["processed"]` outputs for all ROS1 bags:

- `srcs = all_visual_processed`

### `:<name>__nuscenes_data` (filegroup)

A convenience filegroup containing the NuScenes exporter targets for all bags:

- `srcs = all_nuscenes_processed`  
  (each entry is `:<stem>_rosbag_to_nuscenes`)

### `:<name>__everything` (filegroup)

The global “everything” aggregation:

- Includes **NuScenes** for all bags (ROS1 + ROS2)
- Includes **ROS1 processed** outputs for ROS1 bags
- Includes global `__maps`, `__wm_annos`, `__wm_annos_single_file`

This is the target you typically want when you “want it all”.

---

## Optional: “Print all files created” target (currently commented out)

Your code contains an optional helper:

```python
# print_target = print_nuscenes(
#     input_nuscenes_target = nuscenes_target,
#     stem = stem,
#     tool = "@bagzel//src/starlark/rules/core/mwe_print_filenames:mwe_print_filenames",
# )
```

If you enable it, the usual pattern is:

- Create a list like `all_print_nuscenes = []`
- Append `":" + print_target` per bag
- Optionally add a global filegroup `:<name>__print_nuscenes`
- Append `print_target` into `all_everything` if you want it part of `:<name>__everything`

That makes it easy to run a target that prints (or lists) all outputs produced for a bag.

---

## Common commands

List all generated targets:

```bash
bazel query @example_data//:all
```

Build everything from one macro invocation:

```bash
bazel build @example_data//:<name>__everything
```

Build only NuScenes exports:

```bash
bazel build @example_data//:<name>__nuscenes_data
```

Build only the ROS1 visual outputs:

```bash
bazel build @example_data//:<name>__visual_data
```

---

## Notes and troubleshooting

- If you see missing maps or merged annotations, check whether any ROS1 bag is considered **valid** (`r["valid"] == True`), because those global steps use only valid bags.
- ROS2 bags will not contribute to `__visual_data`, `__oxts_all`, `__maps`, or merged annotations; they contribute to NuScenes only.